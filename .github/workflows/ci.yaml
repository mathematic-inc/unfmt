name: Continuous integration

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  merge_group:
    branches: [main]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  checks:
    name: Check code
    runs-on: ubuntu-latest
    steps:
      - name: Check out repository
        uses: actions/checkout@b80ff79f1755d06ba70441c368a6fe801f5f3a62
      - name: Set up Rust
        run: rustup default nightly
      - name: Install development tools
        uses: taiki-e/install-action@9c2797b8f281b478a30f4d5f6720c33372b31e78
        with:
          tool: cargo-deny@0.14.24, cargo-udeps@0.1.48, cargo-hack@0.6.28
      - name: Install Rust linters
        run: rustup component add clippy rustfmt
      - name: Run checks
        run: |
          cargo fmt --check --all
          cargo hack --feature-powerset check --locked --workspace
          cargo hack --feature-powerset clippy --locked --workspace -- -D warnings
          cargo deny check
          cargo udeps --locked --workspace
  tests:
    name: Test on ${{ matrix.os.name }} (${{ matrix.channel }})
    runs-on: ${{ matrix.os.value }}
    strategy:
      matrix:
        os:
          - name: Linux
            value: ubuntu-latest
          - name: Windows
            value: windows-latest
          - name: macOS
            value: macos-latest
        channel:
          - stable
          - beta
          - nightly
    steps:
      - name: Check out repository
        uses: actions/checkout@b80ff79f1755d06ba70441c368a6fe801f5f3a62
      - name: Set up Rust
        run: rustup default ${{ matrix.channel }}
      - name: Install development tools
        uses: taiki-e/install-action@9c2797b8f281b478a30f4d5f6720c33372b31e78
        with:
          tool: cargo-hack@0.6.28
      - name: Run tests
        run: cargo hack --feature-powerset test --locked
  coverage:
    name: Coverage
    runs-on: ubuntu-latest
    steps:
      - name: Check out repository
        uses: actions/checkout@b80ff79f1755d06ba70441c368a6fe801f5f3a62
      - name: Set up Rust
        run: rustup default nightly
      - name: Install development tools
        uses: taiki-e/install-action@9c2797b8f281b478a30f4d5f6720c33372b31e78
        with:
          tool: cargo-llvm-cov@0.6.9, cargo-hack@0.6.28
      - name: Create directories
        run: mkdir -p target/llvm-cov/lcov
      - name: Generate code coverage
        run: |
          cargo hack --feature-powerset llvm-cov --no-report --branch --locked --workspace
          cargo llvm-cov report --fail-under-lines 85 --lcov --output-path target/llvm-cov/lcov/${{ github.event.repository.name }}.info
      - name: Upload code coverage
        uses: romeovs/lcov-reporter-action@4cf015aa4afa87b78238301f1e3dc140ea0e1ec6
        if: github.event_name == 'pull_request'
        with:
          lcov-file: target/llvm-cov/lcov/${{ github.event.repository.name }}.info
          delete-old-comments: true
  success:
    name: Success
    needs: [checks, tests, coverage]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Check jobs
        uses: re-actors/alls-green@release/v1
        with:
          jobs: ${{ toJSON(needs) }}
